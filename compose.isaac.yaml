# Copyright (c) 2022-2025, The Isaac Lab Project Developers (https://github.com/isaac-sim/IsaacLab/blob/main/CONTRIBUTORS.md).
# All rights reserved.
#
# SPDX-License-Identifier: BSD-3-Clause

# Here we set the parts that would
# be re-used between services to an
# extension field
# https://docs.docker.com/compose/compose-file/compose-file-v3/#extension-fields
x-default-isaac-lab-volumes: &default-isaac-lab-volumes
  # These volumes follow from this page
  # https://docs.omniverse.nvidia.com/app_isaacsim/app_isaacsim/install_faq.html#save-isaac-sim-configs-on-local-disk
  - type: volume
    source: isaac-cache-kit
    target: /isaac-sim/kit/cache
  - type: volume
    source: isaac-cache-ov
    target: /root/.cache/ov
  - type: volume
    source: isaac-cache-pip
    target: /root/.cache/pip
  - type: volume
    source: isaac-cache-gl
    target: /root/.cache/nvidia/GLCache
  - type: volume
    source: isaac-cache-compute
    target: /root/.nv/ComputeCache
  - type: volume
    source: isaac-logs
    target: /root/.nvidia-omniverse/logs
  - type: volume
    source: isaac-carb-logs
    target: /isaac-sim/kit/logs/Kit/Isaac-Sim
  - type: volume
    source: isaac-data
    target: /root/.local/share/ov/data
  - type: volume
    source: isaac-docs
    target: /root/Documents
    # This overlay allows changes on the local files to
    # be reflected within the container immediately
  - type: bind
    source: ../source
    target: /isaaclab/source
  - type: bind
    source: ../scripts
    target: /isaaclab/scripts
  - type: bind
    source: ../docs
    target: /isaaclab/docs
  - type: bind
    source: ../tools
    target: /isaaclab/tools
    # The effect of these volumes is twofold:
    # 1. Prevent root-owned files from flooding the _build and logs dir
    #    on the host machine
    # 2. Preserve the artifacts in persistent volumes for later copying
    #    to the host machine
  - type: volume
    source: isaac-lab-docs
    target: /isaaclab/docs/_build
  - type: volume
    source: isaac-lab-logs
    target: /isaaclab/logs
  - type: volume
    source: isaac-lab-data
    target: /isaaclab/data_storage
    # This volume is used to store the history of the bash shell
  - type: bind
    source: .isaac-lab-docker-history
    target: /root/.bash_history

  # x11
  - type: bind
    source: /tmp/.X11-unix
    target: /tmp/.X11-unix
  - type: bind
    source: /etc/localtime
    target: /etc/localtime
    read_only: true

x-default-isaac-lab-environment: &default-isaac-lab-environment
  - ISAACSIM_PATH=/isaaclab/_isaac_sim
  - OMNI_KIT_ALLOW_ROOT=1
  # x11 forwarding
  - DISPLAY
  - TERM
  - QT_X11_NO_MITSHM=1

x-default-isaac-lab-deploy: &default-isaac-lab-deploy
  resources:
    reservations:
      devices:
        - driver: nvidia
          count: all
          capabilities: [ gpu ]

services:
  # This service is the base Isaac Lab image
  isaac-base:
    build:
      # context: ../
      dockerfile: Dockerfile.isaac
    image: isaac-base
    container_name: isaac-base
    environment: *default-isaac-lab-environment
    volumes: *default-isaac-lab-volumes
    network_mode: host
    deploy: *default-isaac-lab-deploy
    # This is the entrypoint for the container
    entrypoint: bash
    stdin_open: true
    tty: true


volumes:
  # isaac-sim
  isaac-cache-kit:
  isaac-cache-ov:
  isaac-cache-pip:
  isaac-cache-gl:
  isaac-cache-compute:
  isaac-logs:
  isaac-carb-logs:
  isaac-data:
  isaac-docs:
  # isaac-lab
  isaac-lab-docs:
  isaac-lab-logs:
  isaac-lab-data: